# BTB Semantic
```json
{
    "local_user1_AddDevice": [
        [
            "Operation result: Success. Evidence: 'status':0,'msg':'ok'. Reason: Consistent HTTP success responses (status code 0 with 'ok' message) confirm successful device addition."
        ]
    ],
    "local_user1_DeviceControl": [
        [
            "Operation result: Undetermined. Evidence: 'No decisive payload evidence or clear traffic pattern'; 'No decisive payload evidence'; 'Abs_Len patterns'. Reason: Traffic analysis shows only length indicators without operation-relevant content or status codes, with consistent observation of Abs_Len patterns across all reports"
        ]
    ],
    "local_user1_InviteToHome": [
        [
            "Operation result: Success. Evidence: ''error':0,'status':0,'msg':'ok','data':{'qrcode':'11Abs_Len14|'}'. Reason: HTTP 200 with success status and QR code generation confirms invitation success"
        ],
        [
            "Operation result: Success. Evidence: ''error':0,'status':0,'msg':'ok','data':{'qrcode':'11Abs_Len14|'}'. Reason: Repeated success status and QR code generation confirms consistent operation success"
        ]
    ],
    "local_user1_RemoveDevice": null,
    "local_user1_RemoveFromHome": [
        [
            "Operation result: Success. Evidence: ''error':0,'status':0,'msg':'ok''; '/appsync/group/member/delfamilymember'; 'FPSPER{'error':0,'status':0,'msg':'ok'}'. Reason: Consistent success indicators across all reports showing HTTP 200 equivalent status (error:0/status:0) with confirmation message ('ok') from family member removal endpoint."
        ]
    ],
    "local_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: ''status':0'; 'POST|/device/control/v2/sdkcontrol' with response payload containing 'pwr':1'. Reason: Consistent HTTP 200 responses with status:0 and successful power state change in payload confirm control operation success."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Undetermined. Evidence: 'Pattern of UDP packets without control confirmation'; 'UDP traffic patterns'; 'UDP packets with Abs_Len patterns'. Reason: Encrypted UDP traffic consistently lacks decodable success/failure indicators or control confirmation payloads."
        ]
    ],
    "remote_user1_DeviceControl": null,
    "remote_user2_AcceptInvite": [
        [
            "Operation result: Success. Evidence: '/appsync/group/member/invited/joinfamily' with 'error':0,'status':0,'msg':'ok'; 'error':0,'status':0,'msg':'ok','data':{'familyid':'11b9af345feef8afb71de0053611d0eb'}'. Reason: Consistent HTTP 200 responses with success status (error:0, status:0) and confirmation message ('ok'), including successful family group association with target family ID in payload."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: ''name':'Response''. Reason: Consistent successful control responses with 'Response' header across all reports."
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: ''name':'ErrorResponse', 'message':'device reset, please rebind'. Reason: Unanimous error responses indicating device reset requirement with identical error message across all reports."
        ]
    ],
    "remote_user2_QuitHome": [
        [
            "Operation result: Success. Evidence: '{'error':0,'status':0,'msg':'ok'}'; '/appsync/group/member/quitfamily|||||FPSPER{'error':0,'status':0,'msg':'ok'}'. Reason: Consistent HTTP 200 equivalent responses with success status (0) and 'ok' message confirm successful quitfamily operation."
        ],
        [
            "Operation result: Success. Evidence: '{'error':0,'status':0,'msg':'ok'}'; '/appsync/group/member/quitfamily|||||FPSPER{'error':0,'status':0,'msg':'ok'}'. Reason: Repeated success indicators (status:0) with endpoint confirmation demonstrate reliable operation completion."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: '{'status':-30107,'msg':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd'}'; '/appsync/group/member/quitfamily|||||FPSPER{'status':-30107,'msg':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd'}'. Reason: Negative status code (-30107) with consistent error message indicates system rejection of quitfamily request."
        ]
    ],
    "remote_user2_ScanQRCode": [
        [
            "Operation result: Success. Evidence: 'error':0,'status':0,'msg':'ok'. Reason: HTTP 200 equivalent status with success codes and confirmation message."
        ],
        [
            "Operation result: Failed. Evidence: 'error':-2010,'status':-2010. Reason: Negative error codes (-2010) confirm operation rejection."
        ],
        [
            "Operation result: Failed. Evidence: 'error':-2011,'status':-2011. Reason: Negative error codes (-2011) confirm operation rejection."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |
|-------|----------------------|
| S0    | Initial state. |
| S1    | user1 added the device; user2 has no permissions. |
| S2    | Error state. |
| S3    | user1 added the device and invited user2 to become a family member; user2 has not accepted yet. |
| S4    | user1 invited user2 to become a family member; user2 has not accepted yet. |
| S5    | user1 added the device and invited user2 to become a family member; user2 scanned QR code but has not accepted yet. |
| S6    | user1 added the device and invited user2 to become a family member; user2 accepted the invitation and is now a family member with control permissions. |
| S7    | user1 added the device and invited user2 to become a family member; user2 scanned QR code, user1 re-invited, and user2 accepted, becoming a family member with control permissions. |
| S8    | user1 invited user2 to become a family member; user2 accepted the invitation and is now a family member with control permissions. |
| S9    | user1 invited user2 to become a family member; user2 scanned QR code, user1 re-invited, and user2 accepted, becoming a family member with control permissions. |
| S10   | user1 invited user2 to become a family member; user2 scanned QR code but has not accepted yet. |
| S11   | user1 added the device and invited user2 to become a family member; user2 accepted but later quit home, revoking family membership and control permissions. |
| S12   | user1 invited user2 to become a family member; user2 accepted but later quit home, revoking family membership and control permissions. |
| S13   | user1 invited user2 to become a family member; user2 scanned QR code, and user1 re-invited, but user2 has not accepted yet. |
| S14   | user1 added the device and invited user2 to become a family member; user2 scanned QR code, and user1 re-invited, but user2 has not accepted yet. |

## Divergent model
| State | Semantic Description |
|-------|----------------------|
| S0 | Initial state. |
| S1 | user1 added the device; user2 has no permissions. |
| S2 | Error state. |
| S3 | user1 invited user2 to become a family member; user2 has not scanned the QR code yet. |
| S4 | user1 invited user2 to become a family member; user2 scanned the QR code but has not accepted the invitation yet. |
| S5 | user1 invited user2 to become a family member; user2 scanned the QR code and accepted the invitation, becoming a family member with control permissions. |
| S6 | user1 invited user2 to become a family member twice; user2 scanned the QR code and accepted the invitation, becoming a family member with control permissions. |
| S7 | user1 added the device and invited user2 to become a family member twice; user2 scanned the QR code and accepted the invitation, becoming a family member with control permissions. |
| S8 | user1 added the device and invited user2 to become a family member; user2 scanned the QR code and accepted the invitation, becoming a family member with control permissions. |
| S9 | user1 invited user2 to become a family member; user2 scanned the QR code, accepted the invitation, and then quit the home, losing family member status. |
| S10 | user1 added the device and invited user2 to become a family member; user2 scanned the QR code but has not accepted the invitation yet. |
| S11 | user1 added the device and invited user2 to become a family member; user2 has not scanned the QR code yet. |
| S12 | user1 added the device and invited user2 to become a family member; user2 scanned the QR code, accepted the invitation, and then quit the home, losing family member status. |
| S13 | user1 added the device and invited user2 to become a family member twice; user2 scanned the QR code but has not accepted the invitation yet. |
| S14 | user1 invited user2 to become a family member twice; user2 scanned the QR code but has not accepted the invitation yet. |
| S15 | user1 added the device and invited user2 to become a family member twice; user2 scanned the QR code, accepted the invitation, and gained control permissions. |
| S16 | user1 added the device, invited user2 to become a family member twice, and then removed the device; user2 had control permissions before removal. |
| S17 | user1 added the device, invited user2 to become a family member twice, removed the device, and user2 quit the home, losing family member status. |
| S18 | user1 added the device, invited user2 to become a family member twice, removed and re-added the device; user2 quit the home, losing family member status. |
| S19 | user1 added the device and invited user2 to become a family member twice; user2 scanned the QR code, accepted the invitation, gained control permissions, and then quit the home, losing family member status. |
| S20 | user1 added the device and invited user2 to become a family member twice; user2 scanned the QR code, accepted the invitation, gained control permissions, quit the home, and scanned the QR code again. |
| S21 | user1 added the device, invited user2 to become a family member twice, removed and re-added the device; user2 quit the home and scanned the QR code again. |
| S22 | user1 added the device, invited user2 to become a family member twice, removed the device; user2 quit the home and scanned the QR code again. |
| S23 | user1 added the device, invited user2 to become a family member twice, removed the device; user2 quit the home, scanned the QR code, and was invited again. |
| S24 | user1 added the device, invited user2 to become a family member twice, removed and re-added the device; user2 quit the home, scanned the QR code, and was invited again. |
| S25 | user1 added the device and invited user2 to become a family member twice; user2 scanned the QR code, accepted the invitation, gained control permissions, quit the home, scanned the QR code, and was invited again. |
| S26 | user1 added the device and invited user2 to become a family member; user2 scanned the QR code, accepted the invitation, gained control permissions, and then user1 removed the device. |
| S27 | user1 added the device and invited user2 to become a family member; user2 scanned the QR code, accepted the invitation, gained control permissions, user1 removed the device, and user2 quit the home. |
| S28 | user1 added the device and invited user2 to become a family member; user2 scanned the QR code, accepted the invitation, gained control permissions, user1 removed and re-added the device, and user2 quit the home. |
| S29 | user1 added the device and invited user2 to become a family member; user2 scanned the QR code, accepted the invitation, gained control permissions, user1 removed and re-added the device. |
| S30 | user1 added the device and invited user2 to become a family member; user2 scanned the QR code, accepted the invitation, and gained control permissions. |
| S31 | user1 added the device and invited user2 to become a family member; user2 scanned the QR code, accepted the invitation, gained control permissions, and then quit the home. |
| S32 | user1 added the device and invited user2 to become a family member twice; user2 scanned the QR code, accepted the invitation, gained control permissions, user1 removed and re-added the device. |

# Bug Reports
## Base model
* No issues found.

## Divergent model
* **Vulnerability 1: Unauthorized Device Control After Device Removal**
    * **Impact:** User2 retains control permissions over a device even after User1 has removed it, allowing unauthorized device manipulation. This violates the principle of permission revocation upon device removal and could lead to potential unauthorized device control if the device is re-added without proper permission revocation.
    * **Problematic State(s):**
        * `s16`: User2 performs **DeviceControl** operation, receives **NoResponse**, but the system fails to properly revoke permissions, indicating residual access rights.
        * `s17`: User2 attempts **DeviceControl** after quitting home and device removal, receives **NoResponse**, suggesting potential permission retention issues.
        * `s26`: User1 removed the device, but User2's control permissions persist, leading to potential security risks if the device is re-added.
        * `s27`: User2 performs **DeviceControl**, receives **NoResponse**, transitioned to **State 27**, causing potential unauthorized device control.

* **Vulnerability 2: Inconsistent Permission Enforcement After Re-adding Devices**
    * **Impact:** User2 gains control permissions without re-invitation when devices are re-added, violating the principle of explicit permission granting. This allows unauthorized control permissions when devices are re-added without proper re-authorization, bypassing security measures.
    * **Problematic State(s):**
        * `s18`: User2 attempts **DeviceControl** after device re-addition and home quitting, receiving a device reset error instead of a permission denial.
        * `s29`: User2 successfully performs **DeviceControl** after device re-addition, despite having quit the home previously.
        * `s25`: User2, after quitting the home and being re-invited, can regain control permissions without scanning the QR code again.
        * `s32`: User2 regains **DeviceControl** permissions automatically after device re-addition without explicit re-invitation.

* **Vulnerability 3: QR Code Scanning Bypass After Permission Revocation**
    * **Impact:** User2 can re-scan QR codes after quitting home, potentially regaining permissions through inconsistent state transitions. This creates a QR code replay attack surface where User2 can regain permissions through old QR codes after quitting home.
    * **Problematic State(s):**
        * `s20`: User2 scans QR code after quitting home, transitioning back to an active permission state (`s19`) without proper re-authorization.
        * `s21`: User2 scans QR code after device removal and home quitting, creating ambiguity in permission states.
        * `s22`: Shows QR codes remain valid after device removal and home quitting.

* **Vulnerability 4: Information Leakage Through Differential Error Codes**
    * **Impact:** Error codes reveal system state differences that could help attackers enumerate valid user/device states. Attackers can infer system state changes or device status through differential responses to the same operation across different states, potentially leading to unauthorized information disclosure.
    * **Problematic State(s):**
        * `s5` vs `s6`: Different error codes (-2010 vs -2011) for similar QR scan rejection scenarios disclose invitation count differences.
        * `s7` vs `s8`: **ScanQRCode** operation returns different error codes (-2011 vs -2010) for similar states, potentially revealing invitation status.
        * `s18`: Distinct "device reset" error message leaks device re-addition status to unauthorized users.
        * `s24`: User2 can infer the device's re-added status through differential responses to DeviceControl operations.
        * `s28`: User2 performs **DeviceControl**, receives **ErrorResponse**, transitioned to **State 28**, causing information leakage about device reset state.

* **Vulnerability 5: Residual Permissions After Quitting Home**
    * **Impact:** User2 retains some control capabilities even after explicitly quitting the home, leading to potential unauthorized access if User2 rejoins the home. This demonstrates weaknesses in permission revocation mechanisms and improper state transitions.
    * **Problematic State(s):**
        * `s19`: User2 quits the home but can still perform **DeviceControl** operations successfully, causing unauthorized device control after quitting home.
        * `s20`: User2 performs **DeviceControl**, receives **Success**, transitioned to **State 20**, causing unauthorized device control after quitting home.
        * `s31`: User2 quits the home but retains control permissions, which could be exploited if User2 rejoins.

* **Vulnerability 6: Privilege Escalation Through Double Invitation**
    * **Impact:** Multiple invitations create inconsistent permission states where User2 gains elevated privileges, violating the principle of least privilege.
    * **Problematic State(s):**
        * `s15`: Shows User2 gains control permissions after second invitation without proper validation.
        * `s7`/`s8`: Demonstrates permission inconsistency between single vs. double invitation paths.

* **Vulnerability 7: Lack of Permission Revocation Synchronization**
    * **Impact:** Device removal doesn't properly synchronize with home membership status, leading to residual permissions and potential security risks.
    * **Problematic State(s):**
        * `s17`: After device removal and home quitting, system fails to clean up residual permissions (transition to s22 allows QR code reuse).
        * `s27`/`s28`: Shows inconsistent permission states after device removal and re-addition.