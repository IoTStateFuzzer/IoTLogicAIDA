# BTB Semantic
```json
{
    "local_user1_AddDevice": [
        [
            "Operation result: Success. Evidence: 'status':0'; 'msg':'ok'. Reason: Confirmed successful device addition indicated by 'status':0 and 'msg':'ok'."
        ]
    ],
    "local_user1_DeviceControl": [
        [
            "Operation result: Undetermined. Evidence: 'no success/error code or indicator'; 'No decisive status or error codes'; 'short bidirectional UDP packets with no explicit status code'; 'minimal encrypted exchange'; 'No decisive status or error indication'. Reason: No conclusive status or error codes appear in the observed traffic, preventing a definitive determination."
        ]
    ],
    "local_user1_InviteToHome": [
        [
            "Operation result: Success. Evidence: 'invited'; 'status=0'. Reason: Invitation request is indicated as successful by 'invited' with 'status=0', though one report suggests membership not fully verified."
        ],
        [
            "Operation result: Success. Evidence: 'status=0'. Reason: The membership flow is confirmed successful by 'status=0', showing user2 recognized as a family member."
        ]
    ],
    "local_user1_RemoveDevice": null,
    "local_user1_RemoveFromHome": [
        [
            "Operation result: Success. Evidence: 'delfamilymember'; 'error=0'. Reason: The removal call is indicated as successful by 'error=0' from 'delfamilymember', though there is an observation that user2 remains in the final list, the overall conclusion is success."
        ]
    ],
    "local_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: '**'status':0**'. Reason: The device returned a zero status code with no errors, indicating successful control."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Undetermined. Evidence: ''. Reason: No success or error codes were observed in a brief UDP flow, preventing a definitive outcome."
        ]
    ],
    "remote_user1_DeviceControl": null,
    "remote_user2_AcceptInvite": [
        [
            "Operation result: Success. Evidence: 'error':0. Reason: The joinfamily request returned a success code indicating invite acceptance."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'Response'. Reason: Normal 'Response' messages with no error codes indicate successful device control"
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: . Reason: A negative status code indicates the device requires reset or rebind, resulting in operation failure"
        ]
    ],
    "remote_user2_QuitHome": [
        [
            "Operation result: Success. Evidence: 'status=0', 'msg=ok', '/appsync/group/member/quitfamily'. Reason: The server returned a success code indicating a successful quit operation."
        ],
        [
            "Operation result: Success. Evidence: 'status=0', 'msg=ok', '/appsync/group/member/quitfamily'. Reason: The request yielded a zero status code and 'ok' message, indicating successful quitting."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: 'status=-30107', '/appsync/group/member/quitfamily'. Reason: The negative status code indicates the quit operation was not successful."
        ]
    ],
    "remote_user2_ScanQRCode": [
        [
            "Operation result: Success. Evidence: . Reason: Zero error code indicates a successful QR code scan."
        ],
        [
            "Operation result: Failed. Evidence: . Reason: Negative error code indicates an unsuccessful QR code scan."
        ],
        [
            "Operation result: Failed. Evidence: . Reason: Another negative error code indicates a failed QR code scan."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |
|-------|----------------------|
| 0  | Initial state |
| 1  | Error state |
| 2  | user1 has added the device once; user2 is not invited |
| 3  | user1 has added the device once; user2 is invited but has not accepted |
| 4  | user1 has not added any device; user2 is invited but has not accepted |
| 5  | user1 has added the device once; user2 scanned the invitation code but has not accepted membership |
| 6  | user1 has added the device once; user2 is a family member with control rights |
| 7  | user1 has added the device once; user2 is a family member with control rights |
| 8  | user1 has not added any device; user2 is a family member with control rights to future devices |
| 9  | user1 has not added any device; user2 is a family member with control rights to future devices |
| 10 | user1 has not added any device; user2 scanned the invitation code but has not accepted membership |
| 11 | user1 has not added any device; user2 was previously a family member but is now removed |
| 12 | user1 has added the device once; user2 was removed from the family and is no longer a member |
| 13 | user1 has added the device once; user2 was previously a family member but is now removed |
| 14 | user1 has added the device once; user2 was previously a family member but is now removed |
| 15 | user1 has no device; user2 was previously a family member but is now removed |
| 16 | user1 has no device; user2 was previously a family member but is now removed |
| 17 | user1 has added the device once; user2 was removed and remains outside the family despite scanning |
| 18 | user1 has added the device once; user2 was removed and remains outside the family |
| 19 | user1 has not added any device; user2 is not a family member, and scanning does not restore membership |
| 20 | user1 has added the device once; user2 was a family member but quit the home, losing all control rights |
| 21 | user1 has added the device a second time; user2 is not a family member |
| 22 | user1 has added the device a second time; user2 is not a family member |
| 23 | user1 has added the device a second time; user2 is not a family member, and scanning does not restore membership |
| 24 | user1 has added the device once; user2 was a family member but is now removed |
| 25 | user1 has not added any device; user2 quit the home and is no longer a family member |
| 26 | user1 has no device; user2 was previously a family member but is now removed |
| 27 | user1 has no device; user2 was previously a family member but is now removed, and scanning is ineffective |
| 28 | user1 has added the device once; user2 was removed but is now re-invited (pending acceptance) |
| 29 | user1 has not added any device; user2 was removed but is now re-invited (pending acceptance) |
| 30 | user1 has added the device once; user2 was removed but is now re-invited and has not accepted |
| 31 | user1 has not added any device; user2 was removed but is now re-invited and has not accepted |
| 32 | user1 has added the device a second time; user2 was removed but is now re-invited (pending acceptance) |
| 33 | user1 has not added any device; user2 is invited but has not accepted membership |
| 34 | user1 has added the device once; user2 is invited but has not accepted membership |

# Bug Reports
## Base model
*   **Issue Description:** An authorization flaw (CWE-862) allows user2—who has been removed from the family or has not accepted a re-invitation—to successfully perform “DeviceControl” operations. This violates the permission rules that only valid family members or direct-share recipients may control the device. As a result, an unauthorized user retains or regains control permissions, posing significant security and privacy risks.

*   **Problematic State(s):**
    *   `s13`: Performed **user2|local|DeviceControl** or **user2|remote|DeviceControl**, received **“Success”**, user2 was previously a member but now removed, causing unauthorized control.  
    *   `s14`: Performed **user2|local|DeviceControl** or **user2|remote|DeviceControl**, received **“Success”**, user2 remains removed, causing unauthorized control.  
    *   `s18`: Performed **user2|local|DeviceControl** or **user2|remote|DeviceControl**, received **“Success”**, transitioned to **s13**, user2 was removed and remains outside the family, causing unauthorized control.  
    *   `s30`: Performed **user2|local|DeviceControl** or **user2|remote|DeviceControl**, received **“Success”**, transitioned to **s13**, user2 was re-invited but not accepted, causing unauthorized control.

## Divergent model
*   No issues found.