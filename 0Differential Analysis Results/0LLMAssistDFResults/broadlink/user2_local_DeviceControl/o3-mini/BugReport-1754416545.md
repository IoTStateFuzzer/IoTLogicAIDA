# BTB Semantic
```json
{
    "local_user1_AddDevice": [
        [
            "Operation result: Success. Evidence: ''msg':'ok' and status:0''. Reason: All responses include the explicit indicators 'msg':'ok' and status:0 in their payloads, confirming the successful completion of the AddDevice operation."
        ]
    ],
    "local_user1_DeviceControl": [
        [
            "Operation result: Undetermined. Evidence: **'user1_local'**. Reason: The majority of evidence shows packets with **'user1_local'** lacking explicit success indicators, while one report\u2019s additional 'header' detail does not alter the consensus of insufficient confirmation for a complete DeviceControl exchange."
        ]
    ],
    "local_user1_InviteToHome": [
        [
            "Operation result: Success. Evidence: 'qrcode':'11Abs_Len14|'. Reason: The responses consistently include the QR code value '11Abs_Len14|' alongside successful status indicators, confirming the invitation flow was executed as intended."
        ],
        [
            "Operation result: Success. Evidence: 'qrcode':'11Abs_Len14|'. Reason: A consistent match of the QR code value '11Abs_Len14|' appears in the majority of responses, validating the invite operation despite additional unique details in some packets."
        ]
    ],
    "local_user1_RemoveDevice": null,
    "local_user1_RemoveFromHome": [
        [
            "Operation result: Success. Evidence: 'msg':'ok'. Reason: The delfamilymember endpoint consistently returned a payload with 'msg':'ok', demonstrating error:0 and confirming a successful RemoveFromHome operation."
        ]
    ],
    "local_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: **'/device/control/v2/sdkcontrol'**; **'Response'**. Reason: HTTP POST packets to the /device/control/v2/sdkcontrol endpoint uniformly delivered a Response indication, confirming that the control command executed properly."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: **'user2_local'**; **'UDP'**. Reason: The sustained UDP communication\u2014including bidirectional exchanges and identifier indications from user2_local\u2014demonstrates a positive local control operation despite one ambiguous packet."
        ]
    ],
    "remote_user1_DeviceControl": null,
    "remote_user2_AcceptInvite": [
        [
            "Operation result: Success. Evidence: 'invited/joinfamily'. Reason: The joinfamily API calls consistently return indicators of success, with the common presence of 'invited/joinfamily' and associated flags (such as error:0 and msg:'ok') confirming the accepted invite action."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: **'Response'**. Reason: Consistent device control responses are indicated by the common occurrence of the 'Response' element in each packet, showing no error markers and confirming successful execution."
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: **'ErrorResponse' with 'device reset, please rebind'**. Reason: The control operation is deemed unsuccessful based on the explicit error responses signaling a device reset, as confirmed by the repeated error message."
        ]
    ],
    "remote_user2_QuitHome": [
        [
            "Operation result: Success. Evidence: '{'error':0,'status':0,'msg':'ok'}'. Reason: The evidence from the quitfamily responses explicitly shows error:0, status:0, and msg:'ok', confirming that the operation succeeded despite mention of later network issues."
        ],
        [
            "Operation result: Success. Evidence: '{'error':0,'status':0,'msg':'ok'}'. Reason: The explicit successful quitfamily payload indicates a clear successful outcome, with the evidence unambiguously showing error:0 and a message of 'ok'."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: '{'status':-30107,'msg':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd'}'. Reason: The evidence captured from the quitfamily responses displays an explicit error status (-30107) and a corresponding error message, decisively marking the operation as failed."
        ]
    ],
    "remote_user2_ScanQRCode": [
        [
            "Operation result: Success. Evidence: ''msg':'ok''. Reason: The payload displays a success indication with an 'ok' message, a core component present in every report, objectively confirming success."
        ],
        [
            "Operation result: Failed. Evidence: ''error':-2010''. Reason: The shared payload evidence of error code -2010 clearly signals failure, as the consistent negative error indicator dominates all reports."
        ],
        [
            "Operation result: Failed. Evidence: ''error':-2011''. Reason: The payload\u2019s repeated inclusion of error code -2011 consistently confirms the operation\u2019s failure."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |
|-------|----------------------|
| s0 | Initial state: user1 has not added any device and no invitation has been sent; user2 has no involvement or permissions. |
| s1 | user1 added the device once (device addition count = 1) with no invitation sent; user2 is not invited and holds no control rights. |
| s2 | Error state. |
| s3 | user1 added the device once and sent a family invitation; user2 has been invited but has not yet accepted, so no control rights are granted. |
| s4 | user1 sent a family invitation without adding a device; user2 is in a pending state (invitation issued but acceptance not yet completed) and has no control rights. |
| s5 | user1 added the device once and sent a family invitation; user2 scanned the QR code (initiating the acceptance process) but has not yet formally accepted, so no permanent control rights are granted. |
| s6 | user1 added the device once and sent a family invitation; user2 scanned and accepted the invitation, thereby becoming a family member with permanent control rights over user1’s devices. |
| s7 | user1 added the device once and issued two family invitations; user2 scanned and eventually accepted one of them, establishing family membership with permanent control rights. |
| s8 | user1 sent a family invitation without adding a device; user2 scanned and accepted the invitation, becoming a family member with permanent control rights (effective when a device is added). |
| s9 | user1 sent multiple family invitations without adding a device; user2 scanned and accepted one (typically the second invite), thereby becoming a family member with permanent control rights. |
| s10 | user1 sent a family invitation without adding a device; user2 scanned the QR code but did not complete the acceptance process, leaving the invitation pending with no control rights. |
| s11 | user1 added the device once and sent a family invitation; user2 scanned and accepted the invitation to become a family member but later quit, resulting in the revocation of control rights while the device remains added. |
| s12 | user1 sent a family invitation without adding a device; user2 scanned and accepted the invitation but then quit, which revokes family membership and all associated control rights. |
| s13 | user1 sent a family invitation and user2 scanned the QR code; subsequently, a re-invitation was issued without a follow‐up acceptance, leaving user2’s acceptance pending and no control rights established. |
| s14 | user1 added the device once and sent multiple family invitations; user2 scanned the QR code on the first invitation but did not complete any acceptance, so user2 remains in a pending state without control rights. |

## Divergent model
| State | Semantic Description |
|-------|----------------------|
| s0 | Initial state: user1 has not added any device and no sharing invitation has been issued; user2 has no invitation and no control. |
| s1 | user1 added the device once (device count = 1) without initiating any sharing; user2 has no access. |
| s2 | Error state. |
| s3 | user1 sent a family invitation without adding a device; user2 has not yet scanned or accepted the invitation (pending). |
| s4 | user1 sent an invitation and user2 scanned the QR code; however, no acceptance occurred and no device was added. |
| s5 | user1’s invitation was accepted (after QR scan), making user2 a permanent family member with control rights, though no device was added (device count = 0). |
| s6 | user1 issued two invitations (with an initial QR scan) and user2 accepted the second invitation, establishing family membership; no device was added. |
| s7 | user1 added the device (device count = 1) and completed the invitation process, making user2 a family member with permanent control rights. |
| s8 | user1 added the device (device count = 1) and completed the invitation process, making user2 a family member with permanent control rights. |
| s9 | user1’s invitation was accepted making user2 a family member, but user2 subsequently executed QuitHome, revoking permanent control; no device was added. |
| s10 | user1 added the device (device count = 1) and sent an invitation that was QR scanned but not accepted; user2 remains pending. |
| s11 | user1 added the device (device count = 1) and sent an invitation, but with no QR scan or acceptance, user2 remains without access. |
| s12 | user1 added the device (device count = 1) and completed the invitation, but user2 later executed QuitHome, thereby revoking control rights. |
| s13 | user1 added the device (device count = 1) and initiated an invitation that was initially scanned, but a subsequent re‑invitation was issued without acceptance; user2 remains pending. |
| s14 | With no device added, user1 sent an invitation that was scanned and then re‑sent; user2’s invitation remains pending acceptance. |
| s15 | user1 added the device (device count = 1) and completed the invitation process, resulting in user2 becoming a confirmed family member with active DeviceControl. |
| s16 | user1 added the device (device count = 1) and completed the invitation process, after which the device was removed; however, user2 retains permanent family membership (control rights persist despite device removal). |
| s17 | user1 added the device (device count = 1) and completed the invitation, but after a device removal, user2 executed QuitHome, thereby revoking control rights (membership revoked). |
| s18 | user1 added the device—final count 1 after removal and re‑addition—and completed the invitation; however, subsequent QuitHome by user2 revokes control rights. |
| s19 | user1 added the device (device count = 1) and completed the invitation, but user2 later executed QuitHome, thereby revoking control rights despite the device being present. |
| s20 | user1 added the device (device count = 1) and completed the invitation, but after user2 executed QuitHome, a subsequent QR scan put user2 in a pending state awaiting re‑acceptance (no active control). |
| s21 | user1 added the device—final device count = 1 via removal and re‑addition—and completed the invitation; however, user2 later executed QuitHome and then rescanned the QR code, leaving user2 pending re‑acceptance. |
| s22 | user1 added the device and then removed it (final device count = 0) after invitation acceptance; subsequently, user2 executed QuitHome and rescanned the QR code, leaving user2 in a pending state with no active control. |
| s23 | user1 added the device (device count = 1) and completed the invitation, but after device removal and user2 executing QuitHome, a new invitation was issued following a QR scan, leaving user2 pending. |
| s24 | user1 added the device (final device count = 1 via removal and re‑addition) and completed the invitation; however, after user2 executed QuitHome and rescanned the QR code leading to a re‑invitation, user2’s status is pending re‑acceptance. |
| s25 | user1 added the device (device count = 1) and completed the invitation, but after user2 executed QuitHome and rescanned the QR code followed by a new invitation, user2’s control remains pending re‑acceptance. |
| s26 | user1 added the device (device count = 1) and completed the invitation, after which user1 removed the device (final count = 0); however, since user2 did not quit, user2 retains permanent family membership and control rights. |
| s27 | user1 added the device (device count = 1) and completed the invitation, but after a device removal, user2 executed QuitHome, thereby revoking permanent control and family membership. |
| s28 | user1 added the device (final device count = 1 after removal and re‑addition) and completed the invitation, but user2 later executed QuitHome, revoking control rights. |
| s29 | user1 added the device, then removed it and re‑added it (final device count = 1) after a completed invitation; since user2 did not execute QuitHome, user2 retains permanent family membership and active control. |
| s30 | user1 added the device (device count = 1) and completed the invitation process, granting user2 confirmed family membership with active DeviceControl. |
| s31 | user1 added the device (device count = 1) and completed the invitation, but user2 executed QuitHome, thereby revoking control rights and family membership despite the device being present. |
| s32 | user1 added the device, then removed and re‑added it (final device count = 1) following successful invitation acceptance, so user2 remains a family member with permanent control. |

# Bug Reports
## Base model
* No issues found.

## Divergent model
* **Vulnerability 1: Unauthorized DeviceControl Success in Revoked or Pending Permission States**  
  **Impact:** In multiple divergent transitions the state machine fails to enforce the intended permission revocation or pending re‑acceptance rules. In these cases, user2’s attempt to perform a local DeviceControl operation returns a “Success” response—even when state semantics indicate that control should have been revoked (after a QuitHome) or suspended pending re‑acceptance following re‑invitation. This inconsistent behavior allows an attacker (or a previously legitimate but now revoked user) to continue issuing control commands, potentially leading to unauthorized device manipulation and a violation of critical access control and integrity requirements.  
  **Problematic State(s):**  
  * `s18`: user2 performs a local DeviceControl (often with Symbol CLS_5) after executing QuitHome, yet the operation returns Success despite the expectation that control rights have been revoked.  
  * `s19`: Despite the intended revocation of rights (post QuitHome), the combined operation (often involving an InviteToHome alongside a DeviceControl request) still results in a Success response.  
  * `s20`: Following a QR scan that leaves user2 in a pending re‑acceptance state, the DeviceControl operation unexpectedly returns Success.  
  * `s21`: In a state where user2 should be pending re‑acceptance after a QuitHome event, the subsequent local DeviceControl call still returns Success, breaching the permission model.  
  * `s24`: Even though state semantics indicate that user2 is in a pending re‑acceptance mode following QuitHome and reinvitation, the DeviceControl command returns Success.  
  * `s25`: User2’s local DeviceControl operation returns Success in a state where control rights should remain pending, demonstrating an unauthorized bypass of expected restrictions.  
  * `s28`: After a QuitHome event that should revoke control, the DeviceControl operation again returns Success, allowing inconsistent access.  
  * `s31`: When user2’s family membership is clearly revoked by QuitHome, the DeviceControl command still returns Success, directly conflicting with the intended permission enforcement.

* **Vulnerability 2: Differential Inference from Varying Response Symbols**  
  **Impact:** The responses to the user2 local DeviceControl operation are not uniform across divergent states. Instead, differing response symbols (for example, CLS_5 versus other expected indicators such as CLS_0) are observed based on whether the state reflects a revoked membership, a pending re‑acceptance, or an active state. This differential behavior not only masks the unauthorized success scenario but also inadvertently provides an attacker with a side channel to infer sensitive internal state information. By correlating the returned symbols with known state-transition logic, an attacker could deduce whether actions such as QuitHome have been executed or if a re‑invitation is pending—thereby facilitating targeted exploitation of the system’s access control policies.  
  **Problematic State(s):**  
  * `s18`: The operation returns Success with a distinguishing symbol (e.g. CLS_5) even when the state indicates that rights should have been revoked, offering clues about the internal state.  
  * `s21`: The success response in this pending state is paired with a symbol (CLS_5) that differs from those seen in fully authorized contexts, enabling state inference.  
  * `s24`: Despite user2’s control being pending re‑acceptance, the differential response symbol on a successful DeviceControl operation may leak information regarding the transition status.  
  * `s25`: The unexpected success coupled with its specific symbol provides similar inferential data to an attacker regarding the non‑active yet responsive state.  
  * `s31`: In this state where membership has been revoked, the success result and its associated symbol signal a clear, unintended divergence from the expected failure response, further assisting in differential state inference.