# BTB Semantic
```json
{
    "local_user1_AddDevice": null,
    "local_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: '0x00000040'. Reason: MQTT PUBACK acknowledgment (0x00000040) confirms successful QoS1 command delivery. Traffic pattern observations of trailing 1-byte null packets were insufficient to contradict transaction completion due to absence of explicit error indicators in payloads."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: ''type':'del''. Reason: MQTT deletion command (type='del') confirmed delivered via PUBACK acknowledgment targeting device removal. Execution success inferred from delivery patterns, though explicit result code remains absent in payload."
        ]
    ],
    "local_user1_SharePlug": null,
    "local_user1_UnsharePlug": [
        [
            "Operation result: Success. Evidence: '/api.json/smartlife/m/sharing/device/remove'; 'success':true. Reason: Unshare operation confirmed via '/api.json/smartlife/m/sharing/device/remove' endpoint with explicit 'success':true payload response, indicating operational completion."
        ]
    ],
    "local_user2_DeviceControl": [
        [
            "Operation result: Undetermined. Evidence: ''. Reason: Insufficient traffic volume (single-packet flows) prevents pattern analysis. No device control context or actionable indicators detected in payloads. Absence of MQTT command semantics or status codes prohibits conclusive determination."
        ],
        [
            "Operation result: Undetermined. Evidence: ''. Reason: Control commands delivered via MQTT (smart/mb/in/ topics) without consistent device acknowledgment patterns. Absence of error codes or explicit response patterns prevents verification despite observed command attempts. Encrypted payloads limit status validation."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Undetermined. Evidence: ''. Reason: Control commands sent via MQTT PUBLISH packets but no corresponding PUBACK acknowledgments observed for packet IDs 48 (0x30) and 50 (0x32)."
        ],
        [
            "Operation result: Undetermined. Evidence: '0x00000040'. Reason: Only an unrelated MQTT PUBACK packet (ID 64) observed, no DeviceControl action detected in traffic set."
        ]
    ]
}
```

# State Semantic
## Base model


| State | Semantic Description |
|-------|----------------------|
| S0    | Initial state.       |
| S1    | user1 added the device once; user2 is not a family member and has no permissions. |
| S2    | Error state.         |
| S3    | user1 added the device once and directly shared it with user2; user2 (not a family member) automatically gained control permissions for this device instance. |

## Divergent model


| State | Semantic Description |
|-------|----------------------|
| S0    | Initial state. |
| S1    | user1 added the device once; user2 has no permissions. |
| S2    | Error state. |
| S3    | user1 added the device once and directly shared it; user2 has control permissions for this instance. |
| S4    | user1 added the device once and directly shared it; user2 retains control permissions (undetermined command outcome does not affect permissions). |
| S5    | user1 unshared the device; user2's direct sharing permissions revoked. Device remains added once. |
| S6    | user1 removed the device; user2's permissions revoked due to device removal. Device addition count remains 1. |
| S7    | user1 re-added the device (total additions: 2); user2 has no permissions (requires re-sharing). |
| S8    | user1 re-shared the device after re-adding (total additions: 2); user2 has control permissions for the new instance. |

# Bug Reports
## Base model
*   No issues found.

## Divergent model
*   **Vulnerability 1: Improper Authorization Enforcement After Permission Revocation**  
    **Impact:** The system fails to properly enforce authorization after permission revocation (via unsharing or device removal) and after device re-addition without re-sharing. This allows attackers to retain control capability, potentially leading to unauthorized device manipulation or command execution through undetermined responses that may enable command processing despite revoked permissions.  
    **Problematic State(s):**  
        *   `s5`: Performed **user2|local|DeviceControl**, received **CLS_1 (Undetermined)**, causing **potential command execution despite revoked permissions after unsharing**.  
        *   `s7`: Performed **user2|local|DeviceControl**, received **CLS_0 (Undetermined)**, causing **command attempts on re-added devices without re-authorization, exploiting residual permissions**.  

*   **Vulnerability 2: State Inference via Differential Response Patterns**  
    **Impact:** Variations in response patterns for unauthorized commands enable attackers to infer sensitive system states (e.g., unshared vs. removed device, re-added status, or permission validity), violating confidentiality through observable differences in symbols like CLS_1, CLS_0, and CLS_NoResponse.  
    **Problematic State(s):**  
        *   `s3`: Performed **user2|local|DeviceControl**, received **CLS_1 (Undetermined)**, causing **distinguishable patterns from s7 that expose permission validity differences**.  
        *   `s4`: Performed **user2|local|DeviceControl**, received **CLS_1 (Undetermined)**, causing **response pattern similarity to s3 that contrasts with unauthorized states**.  
        *   `s5`: Performed **user2|local|DeviceControl**, received **CLS_1 (Undetermined)**, causing **differentiation from s6/s7 responses to leak unsharing status**.  
        *   `s6`: Performed **user2|local|DeviceControl**, received **CLS_NoResponse (Failed)**, causing **clear distinction from s5/s7 to confirm device removal**.  
        *   `s7`: Performed **user2|local|DeviceControl**, received **CLS_0 (Undetermined)**, causing **inference of device re-addition without re-sharing through contrast with s5/s3/s4**.