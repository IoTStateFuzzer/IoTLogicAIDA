# BTB Semantic
```json
{
    "local_user1_AddDevice": null,
    "local_user1_DeviceControl": [
        [
            "Operation result: Undetermined. Evidence: 'Abs_Len1'; 'mqtt traffic patterns'; 'smart/mb/in/208580022462ab36ab23'; 'mqtt traffic with topic smart/mb/in/208580022462ab36ab23'. Reason: Consistent MQTT traffic patterns detected (topic smart/mb/in/208580022462ab36ab23) with minimal data transfer (Abs_Len1), but lacking explicit success/failure indicators in payload content."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: ''type':'del''. Reason: MQTT payload contains explicit device deletion confirmation with success status (unanimous consensus)"
        ]
    ],
    "local_user1_SharePlug": [
        [
            "Operation result: Failed. Evidence: ''success':false,'errorCode':'REPETITION_SHARE','errorMsg':'This device has already been shared with the user.''. Reason: Consistent error responses indicate sharing failed due to existing share relationship (REPETITION_SHARE code with matching error message)"
        ],
        [
            "Operation result: Success. Evidence: ''success':true,'result':{'receiverName':'user2','relationId':117443320}'. Reason: Multiple successful responses confirm new sharing relationship established with user2 (including relation ID verification)"
        ]
    ],
    "local_user1_UnsharePlug": [
        [
            "Operation result: Success. Evidence: ''success':true,'status':'ok''; '/api.json/smartlife/m/sharing/device/remove|||||FPSPER{'result':true,'t':|-----------|,'success':true,'status':'ok'}''. Reason: Consistent payload evidence showing successful device removal operation with explicit success status (true), result confirmation, and 'ok' status across all reports."
        ]
    ],
    "local_user2_DeviceControl": [
        [
            "Operation result: Undetermined. Evidence: 'No relevant payload or pattern'; 'Abs_Len2|UAbs_Len12|w3.3Abs_Len115|U'. Reason: No decisive payload evidence or clear traffic pattern for DeviceControl operation, with consistent observation of length patterns but no operational content."
        ],
        [
            "Operation result: Success. Evidence: 'MQTT topic smart/mb/in/208580022462ab36ab23'; 'smart/mb/in/208580022462ab36ab23 MQTT topic + sustained TCP flow'. Reason: Majority consensus confirms MQTT control channel activity with device-specific topic and sustained TCP traffic, though some reports note lack of explicit control confirmation."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'smart/mb/in/208580022462ab36ab23'. Reason: MQTT publish to device control topic with valid message lengths and sustained bidirectional flow."
        ],
        [
            "Operation result: Undetermined. Evidence: 'Abs_Len1'. Reason: Insufficient packet length and data for conclusive analysis."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |  
|-------|----------------------|  
| 0     | Initial state. |  
| 1     | user1 added the device; user2 has no permissions. |  
| 2     | Error state. |  
| 3     | user1 added the device and shared it with user2 via direct device sharing; user2 has temporary control permissions (valid only for this device instance). |

## Divergent model
| State | Semantic Description |
|-------|----------------------|
| 0     | Initial state. |
| 1     | user1 added the device; user2 has no permissions. |
| 2     | Error state. |
| 3     | user1 added the device and shared it with user2 via direct sharing; user2 has temporary control permissions. |
| 4     | user1 added the device and shared it with user2; user2 exercised temporary control permissions. |
| 5     | user1 added the device, shared it with user2, and then revoked sharing; user2 no longer has control permissions. |
| 6     | user1 added the device, shared it with user2, and then removed the device; user2's temporary permissions are revoked. |
| 7     | user1 re-added the device after removal; user2 has no permissions unless reshared. |
| 8     | user1 re-added the device and reshared it with user2; user2 has temporary control permissions again. |

# Bug Reports
## Base model
* No issues found.

## Divergent model
* **Vulnerability 1: Persistent Control After Permission Revocation**
    * **Impact:** User2 retains device control capabilities after their permissions should have been revoked (during unsharing or device removal scenarios), violating permission timeliness rules. This allows unauthorized access and control despite explicit permission revocation by User1.
    * **Problematic State(s):**
        * `s5`: User2 performs **local DeviceControl** after unsharing, receives **success response**, maintaining control despite permission revocation.
        * `s6`: User2 attempts **local DeviceControl** after device removal, receives **empty response (failed)**, but the system should have prevented any control attempt (no-response is insufficient protection).

* **Vulnerability 2: Permission Reactivation Without Re-Sharing**
    * **Impact:** User2 regains control permissions when the device is re-added (s7→s8) without explicit re-sharing by User1, violating direct sharing rules. This creates inconsistent permission states and potential privilege escalation opportunities.
    * **Problematic State(s):**
        * `s7`: User2 performs **local DeviceControl** after device re-addition, receives **undetermined response** (but with observable traffic patterns), suggesting potential control capability without proper re-sharing.
        * `s8`: User2 executes **remote DeviceControl** successfully after device re-addition, despite no re-sharing occurring in state s7→s8 transition.

* **Vulnerability 3: Differential Information Leakage**
    * **Impact:** Response variations in error states may allow attackers to infer system state changes, exposing device/permission status through differential responses and error messages.
    * **Problematic State(s):**
        * `s3/s4/s8`: User1's **SharePlug** operation returns **REPETITION_SHARE error** with consistent error codes/messages, revealing existing share relationships through differential responses.
        * `s6` vs `s7`: User2's **local DeviceControl** receives **no response (failed)** in s6 (device removed) but **undetermined response** in s7 (device re-added), leaking device existence.
        * `s5` vs `s3`: User2's **local DeviceControl** succeeds in s5 (post-unshare) but fails in s3 (valid sharing), revealing permission state inconsistencies.

* **Vulnerability 4: MQTT Traffic Pattern Leakage**
    * **Impact:** Consistent MQTT traffic patterns across multiple states may allow attackers to infer device control activities regardless of permission status, enabling potential correlation attacks.
    * **Problematic State(s):**
        * All states with **DeviceControl** operations showing identical MQTT topic patterns (`smart/mb/in/208580022462ab36ab23`) and length signatures (Abs_Len1).

* **Vulnerability 5: Silent Permission Reactivation**
    * **Impact:** User2's control permissions are silently reactivated when User1 re-shares the device, without explicit acceptance from User2, creating ambiguous permission states.
    * **Problematic State(s):**
        * `s6`: User2's **local DeviceControl** receives **NoResponse**, transitioned to **State s6**, causing **ambiguous permission state that gets silently reactivated in s8**.
        * `s8`: User2's **local DeviceControl** receives **Success**, transitioned to **State s4**, causing **unexpected permission reactivation without explicit re-authorization**.

* **Vulnerability 6: Undetermined Control Feedback**
    * **Impact:** MQTT traffic patterns allow User2 to infer control attempts despite ambiguous responses, violating Principle 2 of differential inference.
    * **Problematic State(s):**
        * `s7`: User2 performs **local DeviceControl**, receives **Undetermined**, transitioned to **State s7**, causing **potential inference of device state through traffic pattern analysis**.