# BTB Semantic
```json
{
    "local_user1_AddDevice": null,
    "local_user1_DeviceControl": [
        [
            "Operation result: Undetermined. Evidence: 'no response/ack'; 'PUBLISH to device topic without response'; 'no response packets observed'. Reason: Undetermined status due to absence of device execution confirmation packets despite MQTT command transmission and broker acknowledgments (PUBACK). Evidence shows one-way command packets with insufficient bidirectional traffic for status validation."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: 'type':'del''. Reason: Explicit payload deletion command confirmed with device identifiers; sustained traffic patterns and control packets (PUBACK 0x40) indicate successful execution without errors."
        ]
    ],
    "local_user1_SharePlug": [
        [
            "Operation result: Failed. Evidence: ''success':false'; ''errorCode':'REPETITION_SHARE''. Reason: Sharing operation failed due to explicit API response indicating device already shared (error code REPETITION_SHARE)."
        ],
        [
            "Operation result: Success. Evidence: ''success':true'; ''status':'ok''. Reason: Device sharing confirmed successful by API success status and operational status 'ok'."
        ]
    ],
    "local_user1_UnsharePlug": [
        [
            "Operation result: Success. Evidence: 'success':true. Reason: Unshare operation to device removal endpoint succeeded with explicit payload confirmation 'success':true across assessment sources. Consensus confirms operational success without authentication or protocol errors."
        ]
    ],
    "local_user2_DeviceControl": [
        [
            "Operation result: Undetermined. Evidence: ''. Reason: Insufficient packet count prevents determining device control operation; single TCP packet lacks decisive control patterns or status verification."
        ],
        [
            "Operation result: Undetermined. Evidence: ''. Reason: MQTT command issued to control topic ('smart/mb/in'). Although bidirectional TCP flows were detected, absence of device acknowledgment or explicit status confirmation prevents operation validation."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: '0x00000040'; 'pattern: QoS1 PUBLISH followed by PUBACK'; 'PUBACK (0x40) following two PUBLISH packets'; '0x00000032, 0x00000040'. Reason: MQTT PUBACK acknowledgments confirm successful command delivery without error payloads, with QoS1 protocol compliance observed in bidirectional flows."
        ],
        [
            "Operation result: Undetermined. Evidence: '0x00000040'. Reason: Isolated PUBACK packet without preceding PUBLISH command provides insufficient evidence of device control operation initiation or execution context."
        ]
    ]
}
```

# State Semantic
## Base model

| State | Semantic Description |
|-------|----------------------|
| 0     | Initial state        |
| 1     | user1 added the device once. user2 is not a family member and has no control permissions. |
| 2     | Error state          |
| 3     | user1 added the device once. user2 is not a family member and has control permissions for this specific device instance, automatically granted via direct device sharing. |

## Divergent model
| State | Semantic Description |
|-------|----------------------|
| S0    | Initial state. |
| S1    | user1 added the device once; user2 has no permissions. |
| S2    | Error state. |
| S3    | user1 added the device once and shared it with user2 via direct sharing; user2 has automatic control permissions for this instance. |
| S4    | user1 added the device once and shared it with user2 via direct sharing; user2 retains control permissions for this instance. |
| S5    | user1 unshared the device with user2; user2's direct control permissions are revoked. |
| S6    | user1 removed the device; user2's permissions for this instance are revoked. |

# Bug Reports


## Base model
*   No issues found.

## Divergent model
*   **Vulnerability 1: Differential Inference of System State via Response Patterns**  
    **Impact:** Attackers can detect permission revocation, device removal, and system state changes by analyzing variations in response symbols (CLS_0 vs CLS_1) and error code patterns. This violates system state confidentiality by enabling attackers to: 1) distinguish between valid and revoked permissions, 2) identify device lifecycle changes, and 3) develop targeted attacks using leaked status information.  
    **Problematic State(s):**  
        *   `s5`: Performed **user2|remote|DeviceControl**, received **CLS_1 (Undetermined with error code 0x00000040)**, transitioned to **State S5**, causing **leakage of permission revocation status** through differential response compared to authorized states (S3/S4 with CLS_0).  
        *   `s6`: Performed **user2|remote|DeviceControl**, received **CLS_1 (Undetermined with error code 0x00000040)**, transitioned to **State S6**, causing **leakage of device removal status** through persistent symbol mismatch with prior authorized operations and initial unshared states.

*   **Vulnerability 2: Stale Permission Retention During Device Lifecycle Operations**  
    **Impact:** Preserves historical permissions during device re-addition and re-sharing scenarios, enabling privilege escalation without explicit re-authorization. This violates direct sharing rules by: 1) allowing retained control after device re-addition (Permission Check Rule #2), and 2) reactivating permissions through state transitions rather than fresh invitations.  
    **Problematic State(s):**  
        *   `s5`: Performed **user1|local|SharePlug**, received **CLS_1 (Success)**, transitioned to **State S4**, causing **re-activation of user2's permissions** without explicit re-invitation during device re-sharing.  
        *   `s6`: Performed **user1|local|AddDevice**, received **transition to S5**, creating scenarios where **user2 retains permissions** for re-added device instances without proper re-authorization.