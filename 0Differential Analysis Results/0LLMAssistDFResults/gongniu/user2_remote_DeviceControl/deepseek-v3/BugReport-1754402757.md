# BTB Semantic
```json
{
    "local_user1_AddDevice": null,
    "local_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: **'{'code':200,'message':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd','result':null,'success':true}'**. Reason: HTTP 200 status code with 'success': true confirms successful device control."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: 'DELETE|api.iotbull.com|/mos/device/v1/devices/mHXk6DR3zDiKDwQd4vRo000000' and '{'code':200,'message':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd','result':null,'success':true}'. Reason: Consistent HTTP DELETE requests with status code 200 and 'success':true confirm successful device removal."
        ]
    ],
    "local_user1_SharePlug": [
        [
            "Operation result: Success. Evidence: 'POST|/mos/share/v1/devices|||||FPSPER{'code':200,'message':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd','result':null,'success':true}'; 'POST|/mos/share/v1/devices|||||FPSPER{'code':200,'success':true}'. Reason: HTTP POST to share endpoint with code 200 and 'success': true indicates successful operation."
        ],
        [
            "Operation result: Failed. Evidence: 'POST|/mos/share/v1/devices|||||FPSPER{'code':|------|,'message':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd','result':null,'success':false}'; 'POST|/mos/share/v1/devices|||||FPSPER{'code':|------|,'success':false}'. Reason: 'success': false in payload indicates operation failure."
        ]
    ],
    "local_user1_UnsharePlug": [
        [
            "Operation result: Success. Evidence: 'POST|/mos/share/v1/devices/cancel' + '{'code':200,'success':true}'. Reason: HTTP POST to unshare endpoint with 200 status code and success=true confirms operation completion."
        ]
    ],
    "remote_user2_AcceptDeviceShare": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: '{'code':200,'success':true}'; 'code':200, 'success':true. Reason: HTTP 200 status code with 'success': true confirms successful operation."
        ],
        [
            "Operation result: Failed. Evidence: '{'success':false}'; 'success':false. Reason: 'success': false in payload indicates operation failure."
        ],
        [
            "Operation result: Failed. Evidence: '{'success':false}'; 'success':false. Reason: 'success': false in payload indicates operation failure."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'code':200,'success':true; '{'code':200,'message':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd','result':null,'success':true}'. Reason: HTTP 200 status code and 'success': true consistently confirm successful device control and property update."
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: 'code':9017,'success':false; '{'code':9017,'message':'','result':null,'success':false}'. Reason: HTTP 9017 status code and 'success': false consistently indicate device control failure."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |
|-------|----------------------|
| S0    | Initial state. |
| S1    | user1 added the device; user2 has no permissions. |
| S2    | Error state. |
| S3    | user1 added the device and shared it with user2; user2 has not yet accepted the share. |
| S4    | user1 added the device and shared it with user2; user2 accepted the share and now has control permissions for this device instance. |

## Divergent model
| State | Semantic Description |
|-------|----------------------|
| 0     | Initial state. |
| 1     | user1 added the device; user2 has no permissions. |
| 2     | Error state. |
| 3     | user1 added the device and shared it with user2; user2 has not accepted the share yet. |
| 4     | user1 added the device and shared it with user2; user2 accepted the share and has temporary control permissions. |
| 5     | user1 added the device and shared it with user2; user2 accepted the share and exercised control permissions. |
| 6     | user1 added the device, shared it with user2, and later unshared it; user2's temporary permissions are revoked. |
| 7     | user1 added the device, shared it with user2, unshared it, and reshared it; user2 must re-accept the share to regain permissions. |
| 8     | user1 added the device, shared it with user2, and later removed the device; user2's permissions are revoked. |

# Bug Reports
## Base model
* No issues found.

## Divergent model
* **Vulnerability 1: Stale Permission Exploitation**
    * **Impact:** User2 can continue exercising control permissions after their temporary permissions should have been revoked (during unshared state S6 or after device removal in S8). This allows unauthorized device control during the permission revocation window, potentially leading to security breaches if the device is re-added without proper sharing. Multiple reports confirm this vulnerability persists across states S6, S7, and S8 with successful DeviceControl operations despite revoked permissions.
    * **Problematic State(s):**
        * `s6`: Performed **user2|remote|DeviceControl**, received **Success response**, transitioned to **State S6**, allowing continued device control despite being unshared.
        * `s7`: Performed **user2|remote|DeviceControl**, received **Success response**, transitioned to **State S7**, allowing device control without re-accepting the share.
        * `s8`: Performed **user2|remote|DeviceControl**, received **Failed response**, but the attempt indicates potential for exploitation if not properly handled.

* **Vulnerability 2: Inconsistent Permission Enforcement**
    * **Impact:** The system inconsistently enforces permission checks, allowing User2 to perform DeviceControl operations in states where permissions should be revoked (S6, S7, S8). This creates a race condition where historical permissions might be abused, and User2 can control the device without re-accepting the share in S7. The inconsistency also extends to transitions from S5 to S8 where permissions should be immediately revoked but may temporarily persist.
    * **Problematic State(s):**
        * `s5`: When transitioning to `s8` via device removal, the system should immediately revoke all permissions, but the model shows User2 could theoretically retain temporary access.
        * `s6`: Performed **user2|remote|DeviceControl**, received **Success response**, transitioned to **State S6**, causing confusion between permission revocation semantics and actual system behavior.
        * `s7`: Performed **user2|remote|DeviceControl**, received **Success response**, transitioned to **State S7**, allowing control without valid permissions.
        * `s8`: Performed **user2|remote|DeviceControl**, received **Failed response with code 9017**, transitioned to **State S8**, causing potential differential inference of device state through error code variations.

* **Vulnerability 3: Permission Bypass After Device Removal/Re-acceptance Bypass**
    * **Impact:** User2 can regain full control permissions by simply accepting a share again (S7 to S5) without additional verification or explicit re-authorization from User1. This bypasses the intended re-authentication requirement and could allow permission reactivation without User1's fresh consent. Additionally, User2 retains the ability to accept reshare invitations for devices that were previously removed (transition from S8 to S5 via AcceptDeviceShare).
    * **Problematic State(s):**
        * `s7`: Performed **user2|remote|AcceptDeviceShare**, received **Success response**, transitioned to **State S5**, allowing re-acceptance of shares for removed devices without proper re-verification.
        * `s8`: Performed **user1|local|AddDevice**, received **Success response**, transitioned to **State S6**, causing User2's permissions to be unexpectedly restored when the device is re-added without re-sharing.

* **Vulnerability 4: Information Leakage Through Differential Responses**
    * **Impact:** Different error codes/symbols (CLS_2 vs CLS_0/1 or code 9017) reveal system state differences when User2 attempts DeviceControl in unauthorized states. This violates Principle 2 of differential inference by allowing attackers to infer whether a device exists or its sharing status through distinct failure patterns, potentially aiding further exploitation.
    * **Problematic State(s):**
        * `s8`: Performed **user2|remote|DeviceControl**, received **9017 error code/CLS_2 error**, reveals device removal status through distinct failure pattern differing from other control failure responses.