# BTB Semantic
```json
{
    "local_user1_AddDevice": null,
    "local_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: **'{'code':200,'message':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd','result':null,'success':true}'**. Reason: HTTP 200 status code with 'success': true in payload confirms successful device control operation."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: 'DELETE|/mos/device/v1/devices/mHXk6DR3zDiKDwQd4vRo000000'; 'code':200, 'success':true'; 'DELETE|api.iotbull.com|/mos/device/v1/devices/mHXk6DR3zDiKDwQd4vRo000000'; '{'code':200,'success':true}'. Reason: HTTP DELETE request with status code 200 and success=true consistently confirms successful device removal."
        ]
    ],
    "local_user1_SharePlug": [
        [
            "Operation result: Success. Evidence: 'POST|/mos/share/v1/devices|||||FPSPER{'code':200,'success':true}'. Reason: HTTP POST to share endpoint with code 200 and 'success': true confirms successful operation."
        ],
        [
            "Operation result: Failed. Evidence: 'POST|/mos/share/v1/devices|||||FPSPER{'code':|------|,'success':false}'. Reason: HTTP POST to share endpoint with incomplete code and 'success': false indicates operation failure."
        ]
    ],
    "local_user1_UnsharePlug": [
        [
            "Operation result: Success. Evidence: 'POST /mos/share/v1/devices/cancel', 'code':200, 'success':true. Reason: Consistent HTTP POST to unshare endpoint with 200 status code and success=true confirms operation completion."
        ]
    ],
    "remote_user2_AcceptDeviceShare": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'code':200, 'success':true. Reason: HTTP 200 status code and 'success': true confirm successful operation."
        ],
        [
            "Operation result: Failed. Evidence: 'success':false. Reason: 'success': false indicates operation failure."
        ],
        [
            "Operation result: Failed. Evidence: 'success':false. Reason: 'success': false confirms operation failure."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: '{'code':200,'message':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd','success':true}'; '{'code':200,'message':'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd','result':null,'success':true}'. Reason: HTTP 200 status code with 'success': true confirms successful device control and property update."
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: '{'code':9017,'success':false}'; '{'code':9017,'message':'','result':null,'success':false}'. Reason: HTTP 9017 error code with 'success': false indicates device control operation failure."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |  
|-------|----------------------|  
| S0    | Initial state. |  
| S1    | user1 added the device; user2 has no permissions. |  
| S2    | Error state. |  
| S3    | user1 added the device and shared it with user2; user2 has not yet accepted the share. |  
| S4    | user1 added the device and shared it with user2; user2 accepted the share and now has control permissions for this device instance. |

## Divergent model
| State | Semantic Description |  
|-------|----------------------|  
| 0     | Initial state. |  
| 1     | user1 added the device; user2 has no permissions. |  
| 2     | Error state. |  
| 3     | user1 added the device and shared it with user2; user2 has not yet accepted the share. |  
| 4     | user1 added the device and shared it with user2; user2 accepted the share and has temporary control permissions. |  
| 5     | user1 added the device, shared it with user2, and later revoked the share; user2 no longer has permissions. |  
| 6     | user1 added the device, shared it with user2, and later removed the device; user2's permissions are revoked. |  
| 7     | user1 added the device, shared it with user2, revoked the share, and then reshared it; user2 must accept again to regain temporary control permissions. |

# Bug Reports
## Base model
* No issues found.

## Divergent model
* **Vulnerability 1: Improper Permission Retention/Stale Permission Exploitation**
    * **Impact:** User2 retains the ability to attempt device share acceptance even after device removal or share revocation, indicating improper permission cleanup. This could lead to unauthorized access if the system improperly retains historical sharing states or if re-sharing mechanisms are not properly secured.
    * **Problematic State(s):**
        * `s5`: Performed **user2|remote|AcceptDeviceShare**, received **Failed response (CLS_2/'success':false)**, transitioned to **State s5**, causing **User2 to retain stale share acceptance capability after revocation**.
        * `s6`: Performed **user2|remote|AcceptDeviceShare**, received **Failed response (CLS_3/'success':false)**, transitioned to **State s6**, causing **User2 to retain stale share acceptance capability after device removal**.

* **Vulnerability 2: Differential Information Leakage**
    * **Impact:** Different response symbols (CLS_1, CLS_2, CLS_3) for the same operation (AcceptDeviceShare) across states allow attackers to infer system state changes through differential analysis. This violates Principle 2 by revealing whether User2's permissions were revoked or if the device was removed.
    * **Problematic State(s):**
        * `s4`: Performed **user2|remote|AcceptDeviceShare**, received **CLS_2**, transitioned to **State s4**, causing **potential inference of permission revocation state**.
        * `s5`: Performed **user2|remote|AcceptDeviceShare**, received **CLS_2**, transitioned to **State s5**, causing **clear indication of share revocation**.
        * `s6`: Performed **user2|remote|AcceptDeviceShare**, received **CLS_3**, transitioned to **State s6**, causing **clear differentiation of device removal state**.

* **Vulnerability 3: Improper Authorization in Share Acceptance**
    * **Impact:** User2 can regain control permissions after revocation by accepting a reshare without proper authorization checks, potentially leading to unauthorized device control if the re-sharing process is not properly secured.
    * **Problematic State(s):**
        * `s7`: Performed **user2|remote|AcceptDeviceShare**, received **Success response (CLS_1)**, transitioned to **State s4**, causing **User2 to regain control permissions without proper re-authorization**.

* **Vulnerability 4: Inconsistent Error Handling in Share Operations**
    * **Impact:** The system returns inconsistent error responses (CLS_1 vs CLS_2) for similar share operations, which could allow attackers to infer system state through differential analysis and exposes share operation failure patterns.
    * **Problematic State(s):**
        * `s3`: Performed **user1|local|SharePlug**, received **CLS_1 failure response**, transitioned to **State s3**, exposing **share operation failure pattern**.
        * `s4`: Performed **user1|local|SharePlug**, received **CLS_1**, transitioned to **State 4**, causing **confusing failure during valid sharing**.
        * `s7`: Performed **user1|local|SharePlug**, received **CLS_1**, transitioned to **State 7**, causing **information leakage through differential failure modes**.

* **Vulnerability 5: Lack of Proper Permission Validation**
    * **Impact:** User2 can perform share acceptance actions in states where they should not have any permissions, with the system only rejecting these attempts at the operation stage rather than preventing the attempts through proper permission checks.
    * **Problematic State(s):**
        * `s5`: Performed **user2|remote|AcceptDeviceShare**, received **Failed response**, transitioned to **State s5**, causing **system to process unauthorized share attempts after revocation**.
        * `s6`: Performed **user2|remote|AcceptDeviceShare**, received **Failed response**, transitioned to **State s6**, causing **system to process unauthorized share attempts after device removal**.