# BTB Semantic
```json
{
    "local_user1_AddDevice": null,
    "local_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'code':200; 'success':true'. Reason: Explicit HTTP 200 status and boolean success payload confirm successful command execution."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: 'code':200,'success':true. Reason: Consistent HTTP response payload showing code 200 and success flag true confirms successful device removal operation."
        ]
    ],
    "local_user1_SharePlug": [
        [
            "Operation result: Success. Evidence: ''success':true'. Reason: Payload analysis confirms explicit success flag (success:true) in share endpoint responses, indicating operational success."
        ],
        [
            "Operation result: Failed. Evidence: ''success':false'. Reason: Payload examination reveals explicit failure indicator (success:false) across share endpoint responses, confirming operational failure."
        ]
    ],
    "local_user1_UnsharePlug": [
        [
            "Operation result: Success. Evidence: 'code':200,'success':true'. Reason: Explicit success flag ('success':true) in API response payload combined with HTTP 200 status from cancellation endpoint confirms unshare operation completion."
        ]
    ],
    "remote_user2_AcceptDeviceShare": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'code':200'; 'success':true'. Reason: HTTP 200 status code and explicit 'success':true payload confirmation consistent with successful device share acceptance."
        ],
        [
            "Operation result: Failed. Evidence: 'success':false'. Reason: Explicit 'success':false payload response conclusively indicates API-level failure of share acceptance."
        ],
        [
            "Operation result: Failed. Evidence: 'success':false'. Reason: Rejection confirmed by 'success':false payload response at device share confirmation endpoint."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: {'code':200,'success':true}. Reason: HTTP 200 status with payload success flag confirms command execution; MQTT state changes validate device control completion."
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: {'code':9017,'success':false}. Reason: Explicit failure code (9017) with false success flag in payload indicates cloud API command rejection."
        ]
    ]
}
```

# State Semantic
## Base model

| State | Semantic Description |
|-------|----------------------|
| 0 | Initial state |
| 1 | user1 added the device once. user2 is not a family member and has no permissions. |
| 2 | Error state |
| 3 | user1 added the device once and shared it via direct sharing with user2. user2 has not accepted the invitation and has no permissions. |
| 4 | user1 added the device once and shared it via direct sharing with user2. user2 accepted and now has control permissions limited to this device instance. |

## Divergent model

| State | Semantic Description |
|-------|----------------------|
| S0 | Initial state |
| S1 | user1 added the device once; user2 is not a family member and has no permissions. |
| S2 | Error state |
| S3 | user1 added the device once and shared it directly with user2; user2 has not accepted the invitation and has no permissions. |
| S4 | user1 added the device once and shared it directly with user2; user2 accepted and has control permissions for the device instance. |
| S5 | user1 added the device once; after unsharing, user2 has no permissions. |
| S6 | user1 removed the device; the device is no longer present and user2's permissions are revoked. |
| S7 | user1 added the device once and reshared it directly with user2 after unsharing; user2 has not accepted and has no permissions. |

# Bug Reports
## Base model
*   No issues found.

## Divergent model
*   **Vulnerability 1: Differential State Inference via Error Response Patterns**  
    **Impact:** Attackers (user2) can infer unauthorized system state changes by observing distinct error codes (CLS_2 vs. CLS_3) when attempting to accept non-existent/expired device shares. This violates Principle 2 (Differential Inference) and confidentiality requirements (CWE-200), exposing whether a device was unshared (S5) or permanently removed (S6). The error symbol variations reveal internal device management status and user1's removal actions, enabling attackers to distinguish between temporary permission revocation and permanent device deletion scenarios.  
    
    **Problematic State(s):**  
        *   `s5`: Performed **user2|remote|AcceptDeviceShare**, received **CLS_2 failure**, allowing inference of "device exists but unshared" state through consistent error pattern differentiation.  
        *   `s6`: Performed **user2|remote|AcceptDeviceShare**, received **CLS_3 failure**, uniquely signaling permanent device removal. This creates a detectable pattern that leaks system state transitions beyond attacker permissions, disclosing both device deletion and user1's administrative actions.