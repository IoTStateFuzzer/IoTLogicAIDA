# BTB Semantic
```json
{
    "local_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: '**'switch' service updated to on = 1**; **'switch' with on:1**; **'switch' data {'on':1}**; **'switch' service with on:1**. Reason: The MQTT notifications consistently show the 'switch' updated with on state equal to 1, indicating that the control command executed successfully."
        ]
    ],
    "local_user1_InviteAndAccept": [
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: '**'FPSPER200'**'. Reason: The repeated presence of the 'FPSPER200' evidence in the invite-related POST responses indicates a successful invite operation. Despite one report showing a GET error ('The user don't exist!'), the consistent success status codes override that outlier."
        ],
        [
            "Operation result: Failed. Evidence: '**'Home member is already exist in database.'**'. Reason: The clear duplicate membership error reported in every instance confirms the invite operation failed due to an existing member in the database."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: 'deviceDeleted'. Reason: The HTTP DELETE request and MQTT notification both explicitly include 'deviceDeleted', which confirms the removal of the device."
        ]
    ],
    "local_user1_RemoveFromHome": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'FPSPER200'. Reason: The DELETE operation across reports returned HTTP 200 as evidenced by the repeated marker 'FPSPER200', confirming successful removal from the home system."
        ]
    ],
    "local_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: '**'mainSwitch' with 'on':1**'; '**mainSwitch on:1**'; '**mainSwitch on**'; '**mainSwitch' with on:1 in MQTT payload**'. Reason: MQTT notifications consistently indicate a state change to on for the device's mainSwitch, confirming that the control command executed successfully."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: '**switch' with 'on':0**'; '**switch on:0**'; '**switch with 'on':0**'. Reason: MQTT messages show the device switch set to off (on:0), with the majority of notifications confirming the command\u2019s execution despite some additional details in a minority of reports."
        ]
    ],
    "remote_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: ''errcode':0'. Reason: MQTT ACK responses consistently provided a status code of 'errcode':0, confirming that the DeviceControl operation executed successfully."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: **'errcode':0**. Reason: The MQTT ACK and commandRsp packets consistently return **'errcode':0**, confirming successful device control."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: **'errcode':500000401**. Reason: The MQTT ACK and commandRsp packets consistently return **'errcode':500000401**, confirming a device control execution error."
        ],
        [
            "Operation result: Failed. Evidence: **'errcode':500000404**. Reason: The MQTT ACK and commandRsp packets consistently return **'errcode':500000404**, indicating that the device control command failed."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |
|-------|----------------------|
| s0 | Initial state; no operations have been performed. |
| s1 | Error state; an invalid or unsupported operation sequence was executed. |
| s2 | User1 added the device once (device addition count = 1) without initiating any sharing; user2 remains uninvited and has no control rights. |
| s3 | User1 added the device once and then executed an invite-and-accept action, making user2 a family member with permanent control rights over all user1 devices irrespective of any future device re-additions. |
| s4 | User1 executed an invite-and-accept action without adding a device instance; as a family member, user2 is granted permanent control rights that will apply once a device is added. |

## Divergent model
| State | Final Semantic Description |
|-------|----------------------------|
| s0    | Initial state. |
| s1    | user1 has added the device once (device addition count = 1) with an active device instance, but no invitation or sharing has occurred; user2 has no permissions. |
| s2    | Error state. |
| s3    | user1 issued an invitation that was automatically accepted by user2 before any device was added; user2 becomes a family member with permanent control rights pending device addition. |
| s4    | user1 added one device instance (count = 1) and then invited user2, who automatically accepted, thereby becoming a family member with permanent control rights over that device and any future re-adding of it. |
| s5    | Following one device addition and family member invitation, user2 exercised permanent control rights over the device, confirming active family membership and device sharing. |
| s6    | After device addition and family invitation with user2 exercising control, user1 removed the device instance (count resets), but user2 retains permanent family membership and thus control rights if the device is re-added. |
| s7    | user1 added the device and granted family membership to user2, but subsequently revoked user2’s family membership via RemoveFromHome while the device remains bound; user2’s permanent control rights are revoked despite the device remaining active. |
| s8    | user1 added and shared the device with user2 (family member), who exercised control; later, user1 removed the device and revoked user2’s family membership, resulting in no active device and no permissions for user2. |
| s9    | user1 added the device, invited user2 (family member), removed and re-added the device (total device addition count = 2), but then revoked user2’s family membership with RemoveFromHome; thus, user2 loses permanent control rights despite the active device. |
| s10   | user1 added the device, invited and established user2 as family member with permanent control, removed and re-added the device (total device addition count = 2), and did not revoke membership; user2 retains permanent control rights over the active device. |

# Bug Reports
## Base model
No issues found.

## Divergent model
*   **Vulnerability 1: Differential Error Response Information Disclosure**
*   **Impact:** Analysis from one report indicates that the remote DeviceControl operation returns different error codes depending on subtle conditions in the system state. In particular, when user2 attempts the remote DeviceControl action, the response in some states (for example, state s7 returning errcode 500000401) differs from that in other states (such as s6, s8, and s9 returning errcode 500000404). Although none of these responses allow unauthorized device control or privilege escalation, the variation in the error responses enables an attacker to infer internal system conditions—for instance, whether user2’s family membership has been revoked versus a device simply being inactive. This differential feedback could potentially aid in mapping out the state machine’s internal logic or serve as a reconnaissance step for more targeted attacks.
*   **Problematic State(s):**
    *   `s7`: Performed **user2_remote_devicecontrol**, received **errcode 500000401**, transitioned to **not specified**, causing the inference that the failure is due to revoked family membership.
    *   `s6`, `s8`, `s9`: Performed **user2_remote_devicecontrol**, received **errcode 500000404**, transitioned to **not specified**, causing the inference that the failure is due to either the absence of an active device or other conditions distinct from membership revocation.