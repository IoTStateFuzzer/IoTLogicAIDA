# BTB Semantic
```json
{
    "local_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: **'mainSwitch','data':{'on':1}'**; **''st':'mainSwitch','data':{'on':1}'**; **'{'st':'mainSwitch','data':{'on':1}}'**. Reason: MQTT payloads consistently show successful device control with 'mainSwitch' turned on, confirmed across multiple notifications and packets."
        ]
    ],
    "local_user1_InviteAndAccept": [
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: 'error_code:907134773, error_desc:The user don't exist!'. Reason: User existence check failed with explicit error code and message indicating non-existent user."
        ],
        [
            "Operation result: Failed. Evidence: 'error_code:205002, error_desc:Home member is already exist in database.'. Reason: Membership addition failed due to existing user in database."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: **'{'header':{'notifyType':'deviceDeleted'}}'**; **'HTTP DELETE /smart-life/v2/devices/'**; **''notifyType':'deviceDeleted''**; **'notifyType:'deviceDeleted''**; **'DELETE|smarthome.hicloud.com|/smart-life/v2/devices/'**. Reason: Consistent evidence of MQTT notifications with 'deviceDeleted' type and HTTP DELETE requests to the device endpoint confirm successful device removal."
        ]
    ],
    "local_user1_RemoveFromHome": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'DELETE|smarthome.hicloud.com|/smart-life/v3/home/gut9j9nkcp37t3puhqvj/member/Abs_Len26||||||FPSPER200'. Reason: HTTP DELETE request with 200 status code confirms successful removal of the member."
        ]
    ],
    "local_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'st:switch,data:{on:1}'; '{'st':'switch','data':{'on':1}}'. Reason: MQTT packets consistently show switch status changed to 'on', confirming successful control. Undetermined results due to encrypted UDP traffic lack conclusive evidence."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: '{'st':'switch','data':{'on':0}}'; 'st:switch,data:{on:0}'. Reason: Multiple MQTT packets confirm switch status changed to 'off', indicating successful control. Additional evidence of 'on':1 status is noted but does not contradict the majority result."
        ]
    ],
    "remote_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'errcode':0. Reason: Consistent MQTT responses with 'errcode':0 confirm successful device control operations."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: '{'errcode':0}'. Reason: MQTT response consistently indicates successful operation with 'errcode:0' across all reports."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: '{'errcode':500000401}'. Reason: MQTT response consistently indicates failure with 'errcode:500000401' across all reports."
        ],
        [
            "Operation result: Failed. Evidence: '{'errcode':500000404}'. Reason: MQTT response consistently indicates failure with 'errcode:500000404' across all reports."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |
|-------|----------------------|
| 0     | Initial state.       |
| 1     | Error state.         |
| 2     | user1 added the device. |
| 3     | user1 added the device; attempted to invite user2 but failed due to non-existent user. |
| 4     | Attempted to invite user2 but failed due to non-existent user. |

## Divergent model
| State | Semantic Description |
|-------|----------------------|
| 0     | Initial state. |
| 1     | user1 added the device; user2 has no permissions. |
| 2     | Error state. |
| 3     | user1 attempted to invite and accept user2, but the operation failed due to non-existent user. |
| 4     | user1 added the device and attempted to invite and accept user2, but the operation failed due to non-existent user. |
| 5     | user1 added the device and attempted to invite and accept user2, but the operation failed due to non-existent user; user2 attempted to control the device without permissions. |
| 6     | user1 added the device, failed to invite and accept user2, user2 attempted to control the device without permissions, and user1 removed the device. |
| 7     | user1 added the device, failed to invite and accept user2, user2 attempted to control the device without permissions, and user1 removed user2 from the home. |
| 8     | user1 added the device, failed to invite and accept user2, user2 attempted to control the device without permissions, user1 removed the device, and removed user2 from the home. |
| 9     | user1 added the device, failed to invite and accept user2, user2 attempted to control the device without permissions, user1 removed the device, re-added it, and removed user2 from the home. |
| 10    | user1 added the device, failed to invite and accept user2, user2 attempted to control the device without permissions, user1 removed the device, and re-added it. |

# Bug Reports
## Base model
*   No issues found.

## Divergent model
*   **Vulnerability 1: Unauthorized Device Control by User2**
    *   **Impact:** User2, who lacks proper permissions, is able to control the device both remotely and locally in multiple states. This unauthorized access could lead to misuse of the device, compromising system security and integrity. The issue persists across various states, including when the device is re-added or transitions between states.
    *   **Problematic State(s):**
        *   `s4`: Performed **user2|remote|DeviceControl**, received **Success**, transitioned to **State s5**, causing **User2 gained unauthorized control over the device**.
        *   `s5`: Performed **user2|remote|DeviceControl**, received **Success**, transitioned to **State s5**, causing **User2 maintained unauthorized control over the device**.
        *   `s10`: Performed **user2|remote|DeviceControl**, received **Success**, transitioned to **State s5**, causing **User2 regained unauthorized control over the device after it was re-added**.
        *   `s10`: Performed **user2|local|DeviceControl**, received **Success**, transitioned to **State 10**, causing **User2 gained local control of the device without proper permissions**.
        *   `s5`: Performed **user2|local|DeviceControl**, received **Success**, transitioned to **State 5**, causing **User2 retained local control of the device without proper permissions**.

*   **Vulnerability 2: Information Leakage through Error Codes and Messages**
    *   **Impact:** Error codes and messages reveal internal system states, user existence, and permission details, which could be exploited by attackers to infer system behavior, valid user accounts, and device states. This leakage of sensitive information increases the risk of targeted attacks and unauthorized access.
    *   **Problematic State(s):**
        *   `s3`: Performed **user1|local|InviteAndAccept**, received **Failed with error_code:205002, error_desc:Home member is already exist in database.**, transitioned to **State s3**, causing **Leakage of user existence in the database**.
        *   `s4`: Performed **user1|local|InviteAndAccept**, received **Failed with error_code:205002, error_desc:Home member is already exist in database.**, transitioned to **State s4**, causing **Leakage of user existence in the database**.
        *   `s5`: Performed **user1|local|InviteAndAccept**, received **Failed with error_code:205002, error_desc:Home member is already exist in database.**, transitioned to **State s5**, causing **Leakage of user existence in the database**.
        *   `s6`: Performed **user1|local|InviteAndAccept**, received **Failed with error_code:205002, error_desc:Home member is already exist in database.**, transitioned to **State s6**, causing **Leakage of user existence in the database**.
        *   `s10`: Performed **user1|local|InviteAndAccept**, received **Failed with error_code:205002, error_desc:Home member is already exist in database.**, transitioned to **State s10**, causing **Leakage of user existence in the database**.
        *   `s6`: Performed **user2|remote|DeviceControl**, received **Failed. Evidence: {'errcode':500000404}**, transitioned to **State s6**, causing **Information about the device's non-existence to be leaked**.
        *   `s7`: Performed **user2|remote|DeviceControl**, received **Failed. Evidence: {'errcode':500000401}**, transitioned to **State s7**, causing **Information about User2's lack of permissions to be leaked**.
        *   `s8`: Performed **user2|remote|DeviceControl**, received **Failed. Evidence: {'errcode':500000404}**, transitioned to **State s8**, causing **Information about the device's non-existence to be leaked**.
        *   `s9`: Performed **user2|remote|DeviceControl**, received **Failed. Evidence: {'errcode':500000404}**, transitioned to **State s9**, causing **Information about the device's non-existence to be leaked**.

*   **Vulnerability 3: Inconsistent Error Handling**
    *   **Impact:** The system inconsistently handles error responses for User2's device control attempts, sometimes allowing access and sometimes denying it without a clear pattern. This inconsistency could be exploited to infer system state changes or user/device states, further increasing the risk of unauthorized access.
    *   **Problematic State(s):**
        *   `s6`: Performed **user2|remote|DeviceControl**, received **Failed. Evidence: {'errcode':500000404}**, transitioned to **State s6**, causing **Inconsistent error handling**.
        *   `s7`: Performed **user2|remote|DeviceControl**, received **Failed. Evidence: {'errcode':500000401}**, transitioned to **State s7**, causing **Inconsistent error handling**.
        *   `s8`: Performed **user2|remote|DeviceControl**, received **Failed. Evidence: {'errcode':500000404}**, transitioned to **State s8**, causing **Inconsistent error handling**.
        *   `s9`: Performed **user2|remote|DeviceControl**, received **Failed. Evidence: {'errcode':500000404}**, transitioned to **State s9**, causing **Inconsistent error handling**.

These vulnerabilities highlight critical security risks in the Divergent model, including unauthorized access, information leakage, and inconsistent error handling, which must be addressed to ensure the system's integrity and confidentiality.