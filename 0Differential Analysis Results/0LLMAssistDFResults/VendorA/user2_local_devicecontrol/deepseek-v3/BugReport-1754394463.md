# BTB Semantic
```json
{
    "local_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: **''notifyType':'deviceDataChanged''**; **'{'st':'mainSwitch','data':{'on':1}}'**; **'MQTT smarthome.notify.app.v1: deviceDataChanged'**. Reason: MQTT notifications confirm successful device state changes, particularly the mainSwitch and switch status updates to 'on'."
        ]
    ],
    "local_user1_InviteAndAccept": [
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: 'error_code:907134773, error_desc:The user don't exist!'. Reason: GET request failed with error indicating the user doesn't exist."
        ],
        [
            "Operation result: Failed. Evidence: 'error_code:205002, error_desc:Home member is already exist in database.'. Reason: POST request failed as the home member already exists."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: 'notifyType':'deviceDeleted'; 'HTTP DELETE /smart-life/v2/devices/'. Reason: Consistent MQTT notification ('deviceDeleted') and HTTP DELETE requests confirm successful device removal with endpoint verification."
        ]
    ],
    "local_user1_RemoveFromHome": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'DELETE|smarthome.hicloud.com|/smart-life/v3/home/gut9j9nkcp37t3puhqvjnf8/member/Abs_Len26||||||FPSPER200'; 'DELETE|smarthome.hicloud.com|/smart-life/v3/home/gut9j9nkcp37t3puhqvj/member/Abs_Len26||||||FPSPER200'. Reason: HTTP DELETE request with status code 200 confirms successful removal of the member from the smart home system."
        ]
    ],
    "local_user2_DeviceControl": null,
    "remote_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: **'errcode':0**; **'{'header':{'mode':'ACK','notifyType':'commandRsp','method':'POST','requestId':'Abs_Len8|-Abs_Len4|-4Abs_Len3|-Abs_Len4|-Abs_Len12|','from':'/devices/Abs_Len8|-Abs_Len4|-4Abs_Len3|-Abs_Len4|-Abs_Len12|/services/switch','mqttTopic':'smarthome.notify.app.v1','to':'/users/30086000763845487','category':'device','deviceId':'Abs_Len8|-Abs_Len4|-4Abs_Len3|-Abs_Len4|-Abs_Len12|','timestamp':'|--------------|'},'body':{'errcode':0,'devicectltype':0,'devicedelay':5}}'**. Reason: MQTT ACK response with 'errcode:0' consistently confirms successful device control across all reports."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: **'{'errcode':0}'**. Reason: MQTT response with errcode 0 indicates successful device control."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: **'{'errcode':500000401}'**. Reason: MQTT response with errcode 500000401 indicates a device control failure."
        ],
        [
            "Operation result: Failed. Evidence: **'{'errcode':500000404}'**. Reason: MQTT response with errcode 500000404 indicates a device control failure."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |
|-------|----------------------|
| 0     | Initial state.       |
| 1     | Error state.         |
| 2     | user1 added the device; user2 has no permissions. |
| 3     | user1 added the device; attempted to invite and accept user2 as a family member but failed due to user2 not existing. |
| 4     | Attempted to invite and accept user2 as a family member but failed due to user2 not existing. |

## Divergent model
| State | Semantic Description |
|-------|----------------------|
| 0     | Initial state. |
| 1     | user1 added the device; user2 has no permissions. |
| 2     | Error state. |
| 3     | user1 attempted to invite user2, but the operation failed due to user2 not existing; user2 has no permissions. |
| 4     | user1 added the device and attempted to invite user2, but the operation failed due to user2 not existing; user2 has no permissions. |
| 5     | user1 added the device and attempted to invite user2, but the operation failed due to user2 not existing; user2 attempted to control the device but has no permissions. |
| 6     | user1 added the device, attempted to invite user2 (failed), user2 attempted to control the device (no permissions), and user1 removed the device. |
| 7     | user1 added the device, attempted to invite user2 (failed), user2 attempted to control the device (no permissions), and user1 removed the device from home. |
| 8     | user1 added the device, attempted to invite user2 (failed), user2 attempted to control the device (no permissions), user1 removed the device, and then removed it from home. |
| 9     | user1 added the device, attempted to invite user2 (failed), user2 attempted to control the device (no permissions), user1 removed the device, re-added it, and then removed it from home. |
| 10    | user1 added the device, attempted to invite user2 (failed), user2 attempted to control the device (no permissions), user1 removed the device, and re-added it. |

# Bug Reports
## Base model
* No issues found.

## Divergent model
* **Vulnerability 1: Unauthorized Device Control Attempt**
    * **Impact:** User2 attempts to control the device without proper permissions, potentially leading to unauthorized access or control of the device. This issue is persistent across multiple states, indicating a significant security risk.
    * **Problematic State(s):**
        * `s4`: Performed **user2|local|DeviceControl**, received **user2|local|DeviceControl_CLS_0**, transitioned to **State 5**, causing **unauthorized control attempt**.
        * `s5`: Performed **user2|local|DeviceControl**, received **user2|local|DeviceControl_CLS_0**, transitioned to **State 5**, causing **repeated unauthorized control attempt**.
        * `s7`: Performed **user2|local|DeviceControl**, received **user2|local|DeviceControl_CLS_0**, transitioned to **State 5**, causing **unauthorized control attempt**.
        * `s9`: Performed **user2|local|DeviceControl**, received **user2|local|DeviceControl_CLS_3**, transitioned to **State 9**, causing **unauthorized control attempt**.
        * `s10`: Performed **user2|local|DeviceControl**, received **user2|local|DeviceControl_CLS_0**, transitioned to **State 5**, causing **unauthorized control attempt**.

* **Vulnerability 2: Information Leakage via Response Differences**
    * **Impact:** User2 can infer unauthorized system state changes or user/device states through response variations from the same operation across different states. This could lead to further exploitation of the system.
    * **Problematic State(s):**
        * `s6`: Performed **user2|local|DeviceControl**, received **Operation result: Failed. Reason: response is empty**, transitioned to **State 6**, causing **potential inference of device removal**.
        * `s8`: Performed **user2|local|DeviceControl**, received **Operation result: Failed. Reason: response is empty**, transitioned to **State 8**, causing **potential inference of device removal**.

* **Vulnerability 3: Misleading Success Response**
    * **Impact:** The system incorrectly indicates successful device control operations for unauthorized users, which could mislead administrators or users about the actual security state.
    * **Problematic State(s):**
        * `s4`: Performed **user2|remote|DeviceControl**, received **Success**, transitioned to **State 4**, causing **misleading permission confirmation**.
        * `s5`: Performed **user2|remote|DeviceControl**, received **Success**, transitioned to **State 5**, causing **misleading permission confirmation**.
        * `s10`: Performed **user2|remote|DeviceControl**, received **Success**, transitioned to **State 10**, causing **misleading permission confirmation**.

These vulnerabilities highlight the need for stricter permission checks, more accurate response mechanisms, and better handling of unauthorized access attempts to prevent security risks.