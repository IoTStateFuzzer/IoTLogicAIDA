# BTB Semantic
```json
{
    "local_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'deviceDataChanged'. Reason: Consistent device data change notifications with no sign of error indicate successful operation."
        ]
    ],
    "local_user1_InviteAndAccept": [
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'FPSPER200'. Reason: The server returned HTTP 200 for the add-member call, indicating the invite was successful."
        ],
        [
            "Operation result: Failed. Evidence: 'error_code=205002'. Reason: The majority consensus is that the system refused the invite because the user was already a member. An alternate perspective indicates the invite was effectively fulfilled by existing membership."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: 'DELETE'; 'deviceDeleted'. Reason: A consensus indicates that the DELETE request was followed by a deviceDeleted notification, confirming successful removal."
        ]
    ],
    "local_user1_RemoveFromHome": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'DELETE'; '200'. Reason: The request returning 200 indicates membership removal was successful."
        ]
    ],
    "local_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'deviceDataChanged'. Reason: MQTT messages and local toggles confirm normal device state changes with no errors, indicating successful control."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'deviceDataChanged'. Reason: MQTT notifications and local updates confirm device state changes with no failures, indicating successful control."
        ]
    ],
    "remote_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'errcode=0'. Reason: 'errcode=0' indicates successful device control with confirmed operational changes"
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'errcode=0'. Reason: A zero error code indicates a successful control request."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: 'errcode=500000401'. Reason: The device responded with error code 500000401, indicating the request was not fulfilled."
        ],
        [
            "Operation result: Failed. Evidence: 'errcode=500000404'. Reason: The device responded with error code 500000404, indicating the request was not fulfilled."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |
|-------|----------------------|
| 0 | Initial state |
| 1 | Error state |
| 2 | user1 has added the device once; user2 is not invited and has no permissions. |
| 3 | user1 has added the device once; user2 is a family member with permanent control rights. |
| 4 | No device is currently added; user2 is a family member with permanent control over all future devices. |

## Divergent model
| State | Semantic Description |
|-------|----------------------|
| s0    | Initial state. |
| s1    | user1 has added the device once; user2 is not invited and has no control. |
| s2    | Error state. |
| s3    | No device is added; user2 is a family member who will automatically gain control when a device is added. |
| s4    | user1 has added the device once; user2 is a family member with full control rights. |
| s5    | user1 has added the device once; user2, as a family member, has already exercised control. |
| s6    | user1 removed the device; user2 remains a family member with no device to control. |
| s7    | user1 still has the device; user2 was removed from the family and no longer has control. |
| s8    | user1 removed the device and revoked user2’s family membership; no device is active, and user2 has no membership or control. |
| s9    | user1 re-added the device (second time) and revoked user2’s family membership; user2 no longer has control. |
| s10   | user1 re-added the device (second time) while user2 remains a family member, so user2 automatically retains control. |

# Bug Reports
## Base model
No issues found.

## Divergent model
*   **Vulnerability 1: User2 retains device control after membership revocation**

    *   **Impact:**  
        This vulnerability allows User2, who has been explicitly removed from the family (and thus should have no valid permissions), to continue operating the device. All five reports emphasize that this constitutes an unauthorized privilege escalation and a clear violation of the permission model. It compromises integrity by enabling control operations that should be forbidden, and potentially confidentiality if any sensitive information can be accessed during these operations. From a CWE perspective, it reflects improper authorization checks (e.g., CWE-285, CWE-863).

    *   **Problematic State(s):**
        *   `s7`: Performed user2|local|DeviceControl, received “Operation result: Success,” remained in s7, causing unauthorized device operation despite user2’s membership being revoked.  
        *   `s9`: Performed user2|local|DeviceControl, received “Operation result: Success,” remained in s9, again allowing user2 to control the device despite revoked permissions.