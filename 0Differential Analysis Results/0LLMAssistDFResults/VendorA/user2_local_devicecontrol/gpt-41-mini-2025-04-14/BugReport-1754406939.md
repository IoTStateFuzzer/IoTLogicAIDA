# BTB Semantic
```json
{
    "local_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'notifyType':'deviceDataChanged' with sequential state changes indicating device responded to commands'; 'notifyType':'deviceDataChanged' with 'switch' service state toggling from 0 to 1'; 'notifyType':'deviceDataChanged' with incremental switch and mainSwitch on/off state changes'; 'deviceDataChanged' with 'switch' state transition from 0 to 1 in MQTT payloads; 'notifyType':'deviceDataChanged' with services like {'switch':{'data':{'on':1}}}'. Reason: Majority consensus evidences MQTT payloads containing 'deviceDataChanged' notifications with consistent switch state transitions from off (0) to on (1), confirming successful device control through observed state updates in device services."
        ]
    ],
    "local_user1_InviteAndAccept": [
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: ''error_code':907134773,'error_desc':'The user don't exist!''. Reason: Explicit error code 907134773 with message 'The user don't exist!' consistently indicates invite target user does not exist, causing invite failure."
        ],
        [
            "Operation result: Failed. Evidence: ''error_code':205002,'error_desc':'Home member is already exist in database.''. Reason: Error code 205002 'Home member is already exist in database.' clearly shows invite failed due to user already existing in the home member database."
        ]
    ],
    "local_user1_RemoveDevice": [
        [
            "Operation result: Success. Evidence: 'HTTP DELETE /smart-life/v2/devices/'; 'MQTT notifyType: deviceDeleted'. Reason: The HTTP DELETE request to the device endpoint combined with the MQTT notification of deviceDeleted consistently confirms successful device removal across all observations."
        ]
    ],
    "local_user1_RemoveFromHome": [
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'DELETE ... /member/... FPSPER200'. Reason: HTTP DELETE requests with status code 200 directly confirm successful removal operations from the member endpoint."
        ]
    ],
    "local_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'mqtt notifyType deviceDataChanged with switch on states 0 to 1'; 'mqtt notify deviceDataChanged with switch on=1'; 'services':[{'st':'switch','data':{'on':1}}] in MQTT notify message. Reason: Majority evidence indicates MQTT notifications consistently report switch state changes from off (0) to on (1), confirming successful device control."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Success. Evidence: 'mqtt notifyType deviceDataChanged with switch on state 0'; 'mqtt notify deviceDataChanged with switch on=0'; 'services':[{'st':'switch','data':{'on':0}}] and deviceDataChanged MQTT messages sequence. Reason: Consensus shows MQTT messages confirm device switch state changes to off (0), demonstrating successful execution of device control."
        ]
    ],
    "remote_user1_DeviceControl": [
        [
            "Operation result: Success. Evidence: ''errcode':0' in MQTT commandRsp messages; ''notifyType':'commandRsp''; multiple deviceDataChanged notifications showing state changes including 'switch' toggling from 0 to 1. Reason: Consensus confirms operation success indicated by errcode 0 in commandRsp acknowledgments, consistent MQTT ACK responses, and multiple bidirectional deviceDataChanged notifications demonstrating effective device state control."
        ]
    ],
    "remote_user2_DeviceControl": [
        [
            "Operation result: Success. Evidence: 'errcode':0'. Reason: Consensus acknowledges MQTT commandRsp with 'errcode':0' as explicit confirmation of successful device control execution and acknowledgment."
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            ""
        ],
        [
            "Operation result: Failed. Evidence: 'errcode':500000401'. Reason: Presence of MQTT 'errcode':500000401' in responses and ACK messages distinctly indicates device control failure."
        ],
        [
            "Operation result: Failed. Evidence: 'errcode':500000404'. Reason: Repeated MQTT response 'errcode':500000404' provides clear and decisive evidence of unsuccessful device control operation."
        ]
    ]
}
```

# State Semantic
## Base model
| State | Semantic Description |
|-------|----------------------|
| 0     | Initial state: user1 has not added the device; user2 has no permissions and is not invited. |
| 1     | Error state: invalid or undefined state reached. |
| 2     | user1 has added the device once; user2 has not been invited and has no permissions. |
| 3     | user1 added the device once; user1 attempted to invite user2 but the invitation failed because user2 does not exist; therefore, user2 has no permissions. |
| 4     | user1 has not added the device; user1 attempted to invite user2 but the invitation failed because user2 does not exist; user2 has no permissions. |

## Divergent model
| State | Semantic Description |
|-------|----------------------|
| 0     | Initial state. No device added; user2 not invited or recognized; user2 has no permissions or family membership. |
| 1     | user1 added the device once; user2 is not invited, does not exist, and has no control permissions or family membership. |
| 2     | Error state. Invalid or undefined operation sequence unrelated to user or device status. |
| 3     | user1 attempted to invite user2 but the invitation failed because user2 does not exist; user1 has not added the device; user2 has no permissions. |
| 4     | user1 added the device once; invitation to non-existent user2 failed; user2 has no permissions or family membership. |
| 5     | user1 added the device once; invitation to non-existent user2 failed; user2 attempted device control without valid permissions or family membership. |
| 6     | user1 added then removed the device once; invitation to non-existent user2 failed; user2 attempted control but has no permissions or family membership. |
| 7     | user1 added the device once; invitation failed for non-existent user2; user2 attempted control; user1 removed user2 from home or family, which has no effect; user2 remains without permissions. |
| 8     | user1 added then removed the device once; invitation failed for non-existent user2; user2 attempted control; user1 removed user2 from home or family (invalid user); user2 has no permissions. |
| 9     | user1 added, removed, then re-added the device once; invitation to non-existent user2 failed; user2 attempted control; user1 removed user2 from home or family (no effect); user2 has no permissions. |
| 10    | user1 added the device twice (removal and re-addition once); invitation failed for non-existent user2; user2 attempted control; user2 has no permissions or family membership. |

# Bug Reports
## Base model
No issues found.

## Divergent model
* **Vulnerability 1: Unauthorized Device Control by Non-existent User2**

* **Impact:**  
User2, who does not exist and lacks any invitation, permissions, or family membership, is able to successfully perform DeviceControl operations on user1â€™s device across multiple states including s4, s5, s7, s9, and s10. This violates fundamental access control and authorization principles by permitting an unauthorized user to control the device, thereby compromising the Confidentiality, Integrity, and Availability (CIA) of the system. The unauthorized control may lead to malicious device manipulation, misuse, or denial of service. Although the operation responses show success and no error codes indicating rejection, no sensitive information about other users or system states is leaked. The crux of the issue lies in insufficient permission enforcement and flawed authentication/authorization handling within the divergent model. This vulnerability is consistently absent in the base model, underscoring a severe security regression.

* **Problematic State(s):**  
    * `s4`: user2 performed **DeviceControl** action, received **Success** response, remained in **s4** or **s5** depending on source, despite having no permissions or family membership, causing **unauthorized device control and violation of access control rules**.  
    * `s5`: user2 performed **DeviceControl** action, received **Success** response, remained in **s5**, with no valid invitation or permissions, causing **unauthorized device control**.  
    * `s7`: user2 performed **DeviceControl** action, received **Success** response, remained in **s7**, even after user1 removed user2 from the home/family and despite invitation failure, causing **unauthorized device control by an invalid user**.  
    * `s9`: user2 performed **DeviceControl** action, received **Success** response, remained in **s9**, despite never being invited or granted permissions, causing **unauthorized device control and security violation**.  
    * `s10`: user2 performed **DeviceControl** action, received **Success** response, transitioned to **s5** or remained in **s5** state, in a repeated add/remove device scenario with failed invitations, causing **unauthorized device control with invalid user state**.